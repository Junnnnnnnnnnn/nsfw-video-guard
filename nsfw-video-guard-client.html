<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>NSFW Analyze Upload</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    body {
      max-width: 720px;
      margin: 40px auto;
      padding: 0 16px;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 12px;
    }

    .card {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, .04);
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin: 10px 0;
    }

    label {
      font-weight: 600;
      min-width: 80px;
    }

    input[type="file"] {
      padding: 6px;
    }

    button {
      padding: 10px 16px;
      border: 0;
      border-radius: 10px;
      cursor: pointer;
      background: #111827;
      color: #fff;
    }

    button:disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    progress {
      width: 100%;
      height: 14px;
    }

    .status {
      margin-top: 10px;
      font-size: 14px;
    }

    .muted {
      color: #6b7280;
    }

    .ok {
      color: #10b981;
    }

    .err {
      color: #ef4444;
      white-space: pre-wrap;
    }

    .hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }

    .endpoint {
      width: 100%;
      padding: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }

    .result {
      margin-top: 20px;
      display: none;
    }

    .result h2 {
      font-size: 16px;
      margin: 0 0 8px 0;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .kpi {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px;
      text-align: center;
    }

    .kpi b {
      font-size: 24px;
      display: block;
      margin-top: 6px;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      color: #374151;
    }
  </style>
</head>

<body>
  <h1>NSFW Analyze Upload (multipart/form-data)</h1>

  <div class="card">
    <div class="row">
      <label for="endpoint">Endpoint</label>
      <input id="endpoint" class="endpoint" type="text" value="http://localhost:3000/nsfw/analyze-upload" />
    </div>

    <div class="row">
      <input id="file" type="file" accept="video/*" />
      <button id="send">Upload & Start Analysis</button>
    </div>

    <progress id="prog" max="100" value="0" hidden></progress>
    <div id="status" class="status muted">Waiting…</div>
    <div class="hint">
      • Once upload is finished, the server will process the video. When complete, a JSON result is returned.<br />
      • Example response: <span class="mono">{ "sexy": "70%", "nude": "10%" }</span>
    </div>
  </div>

  <div id="result" class="card result">
    <h2>Analysis Result</h2>
    <div class="grid">
      <div class="kpi">
        <div>Sexy</div>
        <b id="sexy">-</b>
      </div>
      <div class="kpi">
        <div>Nude</div>
        <b id="nude">-</b>
      </div>
    </div>
    <div class="hint" style="margin-top:10px">
      * Percentages represent the ratio of frames where the property was detected.
    </div>
    <details style="margin-top:10px">
      <summary>View Raw JSON</summary>
      <pre id="rawjson" class="mono" style="background:#f9fafb; padding:12px; border-radius:8px; overflow:auto; margin-top:8px;"></pre>
    </details>
  </div>

  <script>
    const $endpoint = document.getElementById('endpoint');
    const $file = document.getElementById('file');
    const $send = document.getElementById('send');
    const $prog = document.getElementById('prog');
    const $status = document.getElementById('status');

    const $result = document.getElementById('result');
    const $sexy = document.getElementById('sexy');
    const $nude = document.getElementById('nude');
    const $rawjson = document.getElementById('rawjson');

    function setStatus(text, cls = 'muted') {
      $status.className = 'status ' + cls;
      $status.textContent = text;
    }

    function fmtBytes(n) {
      const k = 1024,
        units = ['B', 'KB', 'MB', 'GB', 'TB'];
      let i = 0;
      while (n >= k && i < units.length - 1) {
        n /= k;
        i++;
      }
      return `${n.toFixed(1)} ${units[i]}`;
    }

    function showResult(obj, raw) {
      $sexy.textContent = obj?.sexy ?? '-';
      $nude.textContent = obj?.nude ?? '-';
      $rawjson.textContent = raw ?? '';
      $result.style.display = 'block';
    }

    $send.addEventListener('click', () => {
      const ep = $endpoint.value.trim();
      const file = $file.files[0];

      if (!ep) return setStatus('Please enter an endpoint.', 'err');
      if (!file) return setStatus('Please select a file to upload.', 'err');

      const fd = new FormData();
      fd.append('file', file, file.name);

      const xhr = new XMLHttpRequest();
      xhr.open('POST', ep, true);
      xhr.responseType = 'text';
      xhr.timeout = 0;

      $send.disabled = true;
      $prog.hidden = false;
      $prog.value = 0;
      setStatus(`Uploading… 0% (0 / ${fmtBytes(file.size)})`);
      $result.style.display = 'none';

      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          const pct = Math.round((e.loaded / e.total) * 100);
          $prog.value = pct;
          setStatus(`Uploading… ${pct}% (${fmtBytes(e.loaded)} / ${fmtBytes(e.total)})`);
        }
      };

      xhr.onreadystatechange = () => {
        if (xhr.readyState === XMLHttpRequest.HEADERS_RECEIVED) {
          setStatus('Processing on server… (analyzing video)', 'muted');
        }
      };

      xhr.onerror = () => {
        setStatus('A network error occurred.', 'err');
        $send.disabled = false;
        $prog.hidden = true;
      };
      xhr.onabort = () => {
        setStatus('The request was aborted.', 'err');
        $send.disabled = false;
        $prog.hidden = true;
      };
      xhr.ontimeout = () => {
        setStatus('The request timed out.', 'err');
        $send.disabled = false;
        $prog.hidden = true;
      };

      xhr.onload = () => {
        try {
          if (xhr.status >= 200 && xhr.status < 300) {
            const resText = xhr.responseText || '';
            let resObj = null;
            try {
              resObj = JSON.parse(resText);
            } catch {
              /* not JSON */
            }

            if (resObj && typeof resObj === 'object' && 'sexy' in resObj && 'nude' in resObj) {
              showResult(resObj, JSON.stringify(resObj, null, 2));
              setStatus('Done ✅ Server response received.', 'ok');
            } else if (resText.trim()) {
              showResult(null, resText);
              setStatus(`Done: status ${xhr.status}. (Text response)`, 'ok');
            } else {
              setStatus(`Done: status ${xhr.status}. (No body)`, 'ok');
            }
          } else if (xhr.status === 423) {
            const retryAfter = xhr.getResponseHeader('Retry-After');
            setStatus(`Server is busy (423 Locked). Try again ${retryAfter ? 'in ' + retryAfter + 's' : 'later'}.`, 'err');
          } else {
            setStatus(`Failed: status ${xhr.status}\n${xhr.responseText || ''}`, 'err');
          }
        } finally {
          $send.disabled = false;
          $prog.hidden = true;
        }
      };

      xhr.send(fd);
    });
  </script>
</body>

</html>